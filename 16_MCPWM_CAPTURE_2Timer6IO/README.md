# 16_MCPWM_CAPTURE_2Timer6IO

## 例程简介

介绍ESP32的`MCPWM输入捕获功能`的使用。初始化PWM输出，模拟要捕获的信号。将PWM输出GPIO与输入捕获GPIO连接，观察串口调试输出。

使用 `FreeRTOS` 的 `Task`，创建两个任务：

1. **led_task** ，控制LED闪烁

2. **mcpwm_capture_task** ，初始化6路1KHz-PWM，作为测试信号。再使能6路输入捕获，来测试输出与捕获的准确性。

使用 `mcpwm_capture.c.h` 驱动模块，来对ESP32的 `MCPWM 输入捕获 `进行配置，实现对外部PWM信号的输入捕获。


## 运行现象

* 将PWM输出GPIO与输入捕获GPIO连接，观察串口调试输出。频率、高电平时间、占空比等参数的测量结果，与输出基本一致。（因为PWM输出的频率是ESP-IDF自动计算的，很可能输出就多少有些误差）

* 观察示波器各通道波形。


## 学习内容

1. 输入捕获的应用，`计算捕获频率`、`高电平时间`、`占空比`等参数。

2. 没有依照`ESP-IDF`自带的`Demo`中，用队列的方式处理捕获。`easyio`的输入捕获直接在中断中计算，可实现对更高PWM频率的信号捕获。因为捕获的PWM频率较快，而队列的方式受限于FreeRTOS的运行频率（ESP-IDF默认为100Hz），故`ESP-IDF`自带的`Demo`中，用队列方式的捕获，不能处理 `100/2=50Hz`的PWM信号。而改良后的`easyio`完全可以，可实现同时对6通道的`频率`、`高电平时间`、`占空比`的捕获和计算。

3. 使用上升沿捕获、下降沿捕获来回切换的方式，来实现一个GPIO对一通道 `频率`、`高电平时间`、`占空比` 的计算。

6. `easyIO`最多支持6个GPIO同时输入捕获。两个`MCPWM`的输入捕获互不干扰，并已经在内部封装好，故外部几乎看不到`MCPWM`的存在，直接调用`capture`结构体，便可得知各通道 `频率`、`高电平时间`、`占空比` 的信息。


## 关键函数

```c
// MCPWM输入捕获初始化（最多6路输入捕获IO，每路均可单独测量 高电平脉宽时间、周期、频率、占空比）
void mcpwm_capture_duty_cycle_init(int ch_num, ...);

// 定时器捕获的数据结构体，用来存储6个通道的 获值、跳变沿类型、运算周期频率占空比等数据
extern capture_unit capture;
```


## 注意事项

* 不要更改输入捕获的中断处理函数，`周期`、`频率`、`高电平时间`、`占空比` 的计算已经在`easyIO`内部封装好。上升沿捕获、下降沿捕获自动切换也已经封装。用户直接调用`capture`结构体，便可得知各通道 `频率`、`高电平时间`、`占空比` 的信息。

* 因为没有找到输入捕获定时器的`溢出中断`API，所以不能测量周期特别长的脉冲，只能测量1个定时器周期以内的脉冲（2^32 / 80000000 = 53.7s，也足够绝大多数的应用场合了）。

* `ESP32`的`MCPWM`输入捕获的时钟源，是APB时钟（一般为80MHz），所以捕获的分辨率、精度都非常高。而且两个`MCPWM`的输入捕获和输出在硬件设计上互不影响，使用是来非常灵活。

* 输入捕获也支持任意GPIO映射。（内部有GPIO矩阵，十多M以下的低速数字信号都支持）

* 中断中使用`mcpwm_capture_signal_get_edge`必须要进临界区，否则会导致重启。因为比较繁琐耗费时间，于是干脆用检测GPIO电平的方式，来判断跳变沿类型。（以前在STM32上也这么干过，都非常稳定）

* `PWM输出` 和 `输入捕获` 的GPIO不要共用，easyio库中因为之前用的 25、26，可能造成输入输出的引脚冲突，请根据自己实际电路修改。

IDF的plus版本，没用队列。

* ESP32的`mcpwm`的输入捕获只能做捕获，不能用作计数。关于`编码器`的 `正交解码`、`计数步进脉冲/方向` 计数请看下一章`PCNT`。
